#!/usr/bin/env python
import os
from subprocess import check_output

def add_routing_table(table_name):
    os.makedirs("/etc/iproute2", exist_ok=True)
    table_id = 1
    with open("/etc/iproute2/rt_tables") as f:
        for line in f:
            if line.strip() and not line.startswith("#"):
                this_table_id = int(line.split()[0])
                table_id = max(table_id, this_table_id + 1)
    with open("/etc/iproute2/rt_tables", "a") as f:
        f.write(f"{table_id} {table_name}\n")
    return table_id

def get_rules():
    return check_output(["ip", "rule"]).decode().splitlines()

def delete_routing_table(table_name):
    with open("/etc/iproute2/rt_tables", "r") as f:
        tables = f.read()
    if table_name not in tables:
        return
    for rule in get_rules():
        if f"lookup {table_name}" in rule:
            priority = rule.split(":")[0].strip()
            os.system(f"ip rule del priority {priority}")
    os.system(f"ip route flush table {table_name}")
    with open("/etc/iproute2/rt_tables", "w") as f:
        for line in tables.splitlines():
            if line.split()[1] != table_name:
                f.write(line)

def main():
    import argparse
    parser = argparse.ArgumentParser()
    subparsers = parser.add_subparsers(dest="command")

    parser_add = subparsers.add_parser("add")
    parser_add.add_argument("table_name")

    parser_delete = subparsers.add_parser("delete")
    parser_delete.add_argument("table_name")

    args = parser.parse_args()

    if args.command == "add":
        add_routing_table(args.table_name)
    elif args.command == "delete":
        delete_routing_table(args.table_name)

if __name__ == "__main__":
    main()
