#!/usr/bin/env python
import json

LONG_MIN = -9223372036854775808

def hundred_nanosecond_to_seconds(num):
    return num / 10 / 1000 / 1000

def seconds_to_days(num):
    return num / 60 / 60 / 24

def hundred_nanosecond_to_days(num):
    return seconds_to_days(hundred_nanosecond_to_seconds(num))

def get_password_policy(domain):
    for k in ["maxpwdage", "minpwdage", "forcelogoff", "lockoutduration", "lockoutobservationwindow"]:
        domain[k] = int(domain[k])
    maxpwdage = "Unlimited" if domain['maxpwdage'] == 0 else abs(round(hundred_nanosecond_to_days(domain['maxpwdage'])))
    minpwdage = "Unlimited" if domain['minpwdage'] == 0 else abs(round(hundred_nanosecond_to_days(domain['minpwdage'])))
    forcelogoff = "Unlimited" if domain['forcelogoff'] == LONG_MIN else abs(round(hundred_nanosecond_to_seconds(domain['forcelogoff'])))
    lockoutduration = "Unlimited" if domain['lockoutduration'] == LONG_MIN else abs(round(hundred_nanosecond_to_seconds(domain['lockoutduration'])/60))
    lockoutobservationwindow = "Unlimited" if domain['lockoutobservationwindow'] == LONG_MIN else abs(round(hundred_nanosecond_to_seconds(domain['lockoutobservationwindow'])/60))
    return {
        "Minimum password length": domain['minpwdlength'],
        "Maximum password age (days)": maxpwdage,
        "Minimum password age (days)": minpwdage,
        "Forced log off time (seconds)": forcelogoff,
        "Password history length": domain['pwdhistorylength'],
        "Lockout duration (minutes)": lockoutduration,
        "Lockout observation window (minutes)": lockoutobservationwindow,
        "Lockout threshold": domain['lockoutthreshold']
    }

def get_domains(input_file):
    with open(input_file) as f:
        data = json.load(f)
    for domain in data['data']:
        yield domain['Properties']

if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument("bloodhound_json", nargs="+")
    args = parser.parse_args()

    for inputfile in args.bloodhound_json:
        for domain in get_domains(inputfile):
            print(domain['name'])
            for k, v in get_password_policy(domain).items():
                print(f"\t{k}: {v}")
