#!/usr/bin/env bash
# Wrapper around ip to support using hostnames instead of IP addresses
ip_regex="\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}"

function execute() {
    cmd=/usr/sbin/ip
    if [ "$#" -ge 3 ] && [ "$1" = "r" ] && ([ "$2" = "a" ] || [ "$2" = "d" ]); then
        cmd="sudo $cmd"
    fi
    eval "$cmd" "$@"
}

if [ "$#" -ge 3 ] && [ "$1" = "r" ] && ([ "$2" = "a" ] || [ "$2" = "d" ] || [ "$2" = "g" ]) && ! echo "$host" | rg -q "$ip_regex"; then
    host="$3"
    dig +short "$host" | while read ip; do
        set -- "${@:1:2}" "$ip" "${@:4}"
        execute "$@"
    done
else
    execute "$@"
fi
